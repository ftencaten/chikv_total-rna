---
title: "Data integration"
editor_options: 
  chunk_output_type: console
---

```{r Load libraries}
library(here)
library(tidyverse)
library(edgeR)
library(ggfortify)
library(RColorBrewer)
library(sva)
library(CEMiTool)
```

```{r Load files}
# CSBL CHIKV phenodata
sra.csbl <- read_csv(here("data", "chikv_csbl_star", "SraRunTable.txt"))

sup.csbl <- read_tsv(here("data", "chikv_csbl_star", "ppat.1007880.s001.csv"))

# Arbobios phenodata
pheno.arbo <- read_tsv(here("data", "phenodata.tsv"))

# Human genome annotation
hannot <- read_tsv(here("data", 
                        "Homo_sapiens.GRCh38.100_gene_annotation_table.txt"))

# CSBL read count
counts_csbl <- read_tsv(here("data", "chikv_csbl_star", "CountTable.tsv")) %>% 
  rename(Symbol = genes)

# Arbobobios read count
counts_arbo <- read_tsv(here("data", "geneCounts",
                          "rawCounts_featureCounts_NOTmultimapping.tsv")) %>%
  rename_with(~ sub(".Aligned.sortedByCoord.out.bam", "", .x), 
              ends_with("bam")) %>% 
  rename_with(~ sub("19017", "", .x), everything()) %>% 
  rename_with(~ sub("Aligned.out.bam", "", .x), everything()) %>%
  rename_with(~ paste0("ARB", .x), -Symbol) %>%
  dplyr::select("Symbol", sort(colnames(.)))

gmt.reactn <- read_gmt(here("data", "reactome_data", 
                            "ReactomePathwaysLevel3_2021-03.gmt"))

int_df <- read_tsv(here("data", "interaction_DB", 
                        "9606.gene.physical.links.STRINGv11_HGNC.tsv")) %>% 
  as.data.frame()
```

```{r Join CSBL and Arbobios phenodata + counts}
pheno.csbl <- sra.csbl %>% 
  full_join(sup.csbl, by = c("Sample Name" = "Subject_ID")) %>%
  mutate(condition = if_else(Sample_type == "Control", "healthy", 
                             "infected")) %>% 
  dplyr::select(Run, Label, Days_of_symptoms_Cat, Arthralgia_Chronicity,
                condition) %>% 
  mutate(day = if_else(Days_of_symptoms_Cat == "Control", NA_character_, 
                        Days_of_symptoms_Cat)) %>% 
  mutate(disease.status = case_when(Arthralgia_Chronicity == "ND" ~ NA_character_,
                             Arthralgia_Chronicity == "Y" ~ "chronic",
                             Arthralgia_Chronicity == "N" ~ "nonChronic"))

pheno <- pheno.arbo %>%
  rename(Run = Sample, day = Day) %>% 
  mutate(disease.status = ifelse(Class == "control", "nonChronic", Class)) %>% 
  mutate(condition = "infected") %>% 
  dplyr::select(-Class, - Batch) %>%
  mutate(Run = paste0("ARB", Run)) %>% 
  bind_rows(pheno.csbl %>% dplyr::select(Run, condition, day, 
                                         disease.status)) %>%
  mutate(phase = case_when(day == "D21" ~ "late",
                           day == "D20" ~ "late",
                           day == "D0" ~ "early",
                           day == "D0or1" ~ "early",
                           day == "D2" ~ "early",
                           day == "D3or4" ~ "early",
                           TRUE ~ NA_character_)) %>% 
  relocate(Run, condition, day, phase, disease.status) %>% 
  mutate(dataset = case_when(day == "D0" ~ "arbobios",
                           day == "D21" ~ "arbobios",
                           TRUE ~ "csbl")) %>% 
  mutate(condition = as.factor(condition)) %>% 
  mutate(dataset = as.factor(dataset))

rawcount <- counts_arbo %>% 
  full_join(counts_csbl, by = "Symbol") %>% 
  relocate(Symbol, pheno$Run)
```

```{r Normalization + PCA}
expr <- DGEList(counts = rawcount[,-1], 
                genes = hannot[,c(1,2,4)],
                group = paste(pheno$condition, pheno$phase, 
                              pheno$disease.status, sep = "_"))

expr.nrom <- calcNormFactors(expr, method = "TMM")

tmm.counts <- cpm(expr.norm, log = F)
cpm.counts <- cpm(expr, log = F)

rownames(tmm.counts) <- rawcount$Symbol
rownames(cpm.counts) <- rawcount$Symbol

annot <- pheno %>% 
  dplyr::select(Run, condition, phase, dataset, disease.status) %>% 
  mutate(phase = ifelse(is.na(phase) == T, "healthy", phase)) %>% 
  mutate(disease.status = case_when(phase == "healthy" ~ "healthy", 
                                    phase != 'healthy' &
                                    is.na(disease.status) ~ 'unknown',
                                    TRUE ~ disease.status)) %>% 
  column_to_rownames('Run')

# Select most variant genes
genes.var <- apply(tmm.counts, 1, var)
selectedGenes <- names(genes.var[order(genes.var, decreasing = T)][1:500])

M <- log2(t(tmm.counts[selectedGenes,]) + 1)

pcaResults <- prcomp(M)

pca <- autoplot(pcaResults, data = as.data.frame(annot), 
                colour = "dataset", shape = "phase",
                main = "Arbobios / CSBL datasets") +
  scale_color_manual(values = brewer.pal(3, "Dark2")[2:3]) +
  theme_bw()

ggsave(here("results","figures","PCA_Arbobios_CSBL_dataset.png"), pca, 
       device = "png", width = 10, height = 6, units = "cm", 
       dpi = "print", scale = 2)
```

```{r Combat-seq}
df <- as.matrix(rawcount[,-1])
rownames(df) <- rawcount$Symbol

phase <- ifelse(is.na(pheno$phase) == T, 'healthy', pheno$phase)

adj.count <- ComBat_seq(df, batch = pheno$dataset, group = pheno$condition)

## x
expr.adj <- DGEList(counts = adj.count, 
                    genes = hannot[,c(1,2,4)],
                    group = paste(pheno$condition, pheno$phase, 
                                  pheno$disease.status, sep = "_"))

expr.adj.nrom <- calcNormFactors(expr.adj, method = "TMM")

tmm.counts.adj <- cpm(expr.adj.norm, log = F)
cpm.counts.adj <- cpm(expr.adj, log = F)

# Select most variant genes
genes.var.adj <- apply(tmm.counts.adj, 1, var)
selectedGenes.adj <- names(genes.var[order(genes.var, decreasing = T)][1:500])

M.adj <- log2(t(tmm.counts.adj[selectedGenes.adj,]) + 1)

pcaResults.adj <- prcomp(M.adj)

pca.adj <- autoplot(pcaResults.adj, data = as.data.frame(annot), 
                colour = "dataset", shape = "phase",
                main = "Arbobios / CSBL datasets - Batch correction") +
  scale_color_manual(values = brewer.pal(3, "Dark2")[2:3]) +
  theme_bw()

ggsave(here("results", "figures",
            "PCA_Arbobios_CSBL_dataset_Combatseq_adjusted.png"), 
       pca.adj, device = "png", width = 10, height = 6, units = "cm", 
       dpi = "print", scale = 2)

pca.adj.chron <- autoplot(pcaResults.adj, data = as.data.frame(annot), 
                          colour = "disease.status", shape = "phase",
                          main = "CHIKV Chronicity - Batch correction") +
  scale_colour_viridis(discrete = T) +
  theme_bw()

ggsave(here("results", "figures",
            "PCA_Arbobios_CSBL_dataset_Combatseq_adjusted_chronicity.png"), 
       pca.adj.chron, device = "png", width = 10, height = 6, units = "cm", 
       dpi = "print", scale = 2)

```

```{r CEMiToll}
smpl.annot <- annot %>%
  rownames_to_column("SampleName") %>% 
  select(SampleName, Class = phase)

tmm.counts.adj.hgnc <- tmm.counts.adj %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  inner_join(hannot %>% dplyr::select(gene_id, GeneSymbol)) %>% 
  filter(!duplicated(GeneSymbol)) %>% 
  dplyr::select(-gene_id) %>% 
  column_to_rownames("GeneSymbol")

cpm.counts.adj.hgnc <- cpm.counts.adj %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  inner_join(hannot %>% dplyr::select(gene_id, GeneSymbol)) %>% 
  filter(!duplicated(GeneSymbol)) %>% 
  dplyr::select(-gene_id) %>% 
  column_to_rownames("GeneSymbol")

cem.reactome.tmm <- cemitool(expr = tmm.counts.adj.hgnc, 
                         annot = smpl.annot, apply_vst = T,
                         gmt = gmt.reactn, interactions = int_df, 
                         gsea_max_size = 2e3, verbose = TRUE)

cem.reactome.cpm <- cemitool(expr = cpm.counts.adj.hgnc, 
                         annot = smpl.annot, apply_vst = T,
                         gmt = gmt.reactn, interactions = int_df, 
                         gsea_max_size = 2e3, verbose = TRUE)

# TMM
generate_report(cem.reactome.tmm, title = "CSBL_Arbobios_integration TMM",
                directory = here("results", "CEMiTool", "Report",
                                 "CSBL_Arbobios_integration_TMM"), force = T)
diagnostic_report(cem.reactome.tmm, title = "CSBL_Arbobios_integration TMM",
                  directory = here("results", "CEMiTool", "Diagnostic",
                                   "CSBL_Arbobios_integration_TMM"), force = T)
save_plots(cem.reactome.tmm, "all", 
           directory = here("results", "CEMiTool", "Plots",
                            "CSBL_Arbobios_integration TMM"), force = T)

# CPM
generate_report(cem.reactome.cpm, title = "CSBL_Arbobios_integration CPM",
                directory = here("results", "CEMiTool", "Report",
                                 "CSBL_Arbobios_integration_CPM"), force = T)
diagnostic_report(cem.reactome.cpm, title = "CSBL_Arbobios_integration CPM",
                  directory = here("results", "CEMiTool", "Diagnostic",
                                   "CSBL_Arbobios_integration_CPM"), force = T)
save_plots(cem.reactome.cpm, "all", 
           directory = here("results", "CEMiTool", "Plots",
                            "CSBL_Arbobios_integration CPM"), force = T)
```